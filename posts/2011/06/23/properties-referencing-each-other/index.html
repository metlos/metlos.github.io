<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Reinventing The Wheel</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <link href="http://lukas.krejci.pw/stylesheets/styles.css" rel="stylesheet" type="text/css">
    <link href="http://lukas.krejci.pw/stylesheets/font-awesome/font-awesome.css" rel="stylesheet" type="text/css">
    <script src="http://lukas.krejci.pw/javascripts/lightbox.min.js" type="text/javascript"></script>
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="nav navbar-brand" href="http://lukas.krejci.pw" title="Reinventing The Wheel">
            <i class="fa fa-refresh"></i>
            <i class="fa fa-cog"></i>
          </a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li>
              <a href="http://lukas.krejci.pw/posts" title="Blog">
                <i class="fa fa-pencil"></i>
              </a>
            </li>
            <li>
              <a href="http://lukas.krejci.pw/about" title="About">
                <i class="fa fa-info"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="container" role="main">
      <div class="post-navigation">
        <div class="previous">
          <div class="label">
            &laquo;
          </div>
          <div class="nav-link">
            <a href="/posts/2011/03/30/planning-configuration-and-templates-exportimport-in-rhq/">Planning configuration and templates export/import in RHQ</a>
          </div>
        </div>
        <div class="next">
          <div class="nav-link">
            <a href="/posts/2011/08/04/making-testng-listeners-apply-to-only-certain-classes/">Making TestNG @Listeners apply to only certain classes</a>
          </div>
          <div class="label">
            &raquo;
          </div>
        </div>
      </div>
      <h1 class="title">
        Properties referencing each other
      </h1>
      <div class="author">
        posted on
        <span class="date">
          23 Jun 2011
        </span>
      </div>
      <div class="tags">
        <a class="label label-info" href="http://lukas.krejci.pw/posts/tags/java/">java</a>
      </div>
      <div class="paragraph">
      <p>This must have been done before countless times but because I just
      couldn&#8217;t google anything useful (and to stay true to the name of this
      blog) I implemented it myself yet again.</p>
      </div>
      <div class="paragraph">
      <p>The problem is this. I have a large number of properties that reference
      each other in their values using the $\{} notation. E.g. the following
      property file:</p>
      </div>
      <div class="listingblock">
      <div class="content">
      <pre>message=Hello ${name}!&#x000A;name=Frank</pre>
      </div>
      </div>
      <div class="paragraph">
      <p>My actual use case for this is that I have a large number of
      configuration options that can be passed to a java program as system
      properties (i.e. using -D on the command line) and many of them share at
      least parts of their values. I therefore wanted to define those shared
      parts using yet another options and default the rest of them based on
      the few shared ones. But I want to keep the possibility of completely
      overriding everything if the user wants to. E.g.:</p>
      </div>
      <div class="paragraph">
      <p>These would be specified on the command line:</p>
      </div>
      <div class="listingblock">
      <div class="content">
      <pre>port=111&#x000A;host=localhost</pre>
      </div>
      </div>
      <div class="paragraph">
      <p>And the rest would be defaulted to the values based on the values above:</p>
      </div>
      <div class="listingblock">
      <div class="content">
      <pre>service1=${host}:${port}/service1&#x000A;service2=${host}:${port}/service2</pre>
      </div>
      </div>
      <div class="paragraph">
      <p>But that&#8217;s not all. Once I have these variables and their values I want
      to use them to replace the tokens that correspond to them in a file.
      E.g.:</p>
      </div>
      <div class="listingblock">
      <div class="content">
      <pre>This is a file I am then processing further and I want the service1 URL to be visible right here: ${service1}.</pre>
      </div>
      </div>
      <div class="paragraph">
      <p>Again that is a rather common requirement and nothing too surprising to
      do actually. But I still couldn&#8217;t find some nice and reusable class in
      some standard library that would efficiently do this for me.</p>
      </div>
      <div class="paragraph">
      <p>Then I stumbled upon the
      <a href="http://tutorials.jenkov.com/java-howto/replace-strings-in-streams-arrays-files.html">TokenReplacingReader</a>
      and thought to myself that that&#8217;s exactly the thing I need to solve
      <strong>both</strong> of my problems (after I fixed it slightly, see below).</p>
      </div>
      <div class="paragraph">
      <p>The TokenReplacingReader is ideal for my second usecase - read large
      files and replace tokens in them efficiently. But how do you say does it
      solve my first problem?. Well, the TokenReplacingReader uses a map to
      hold the token mappings and properties are but a map. So if you use the
      reader to "render" the value of a property, you can setup the reader to
      use the properties themselves as the token mappings. Can you see the
      beautiful recursion in there? ;)</p>
      </div>
      <div class="paragraph">
      <p>Ok, so here&#8217;s the code that I came up with:</p>
      </div>
      <div class="listingblock">
      <div class="content">
      <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">/**&#x000A; * This map is basically an extension of the {@link Properties} class that can resolve the references&#x000A; * to values of other keys inside the values.&#x000A; * &lt;p&gt;&#x000A; * I.e., if the map is initialized with the following mappings:&#x000A; * &lt;p&gt;&#x000A; * &lt;code&gt;&#x000A; * name =&gt; world &lt;br /&gt;&#x000A; * hello =&gt; Hello ${name}!&#x000A; * &lt;/code&gt;&#x000A; * &lt;p&gt;&#x000A; * then the call to:&#x000A; * &lt;p&gt;&#x000A; * &lt;code&gt;&#x000A; * get(&quot;hello&quot;)&#x000A; * &lt;/code&gt;&#x000A; * &lt;p&gt;&#x000A; * will return:&#x000A; * &lt;code&gt;&#x000A; * &quot;Hello world!&quot;&#x000A; * &lt;/code&gt;&#x000A; * &lt;p&gt;&#x000A; * To access and modify the underlying unprocessed values, one can use the &quot;raw&quot; counterparts of the standard&#x000A; * map methods (e.g. instead of {@link #get(Object)}, use {@link #getRaw(Object)}, etc.).&#x000A; *&#x000A; * @author Lukas Krejci&#x000A; */</span>&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">TokenReplacingProperties</span> <span style="color:#088;font-weight:bold">extends</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; {&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#339;font-weight:bold">long</span> serialVersionUID = <span style="color:#00D">1L</span>;&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; wrapped;&#x000A;    <span style="color:#088;font-weight:bold">private</span> Deque&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; currentResolutionStack = <span style="color:#080;font-weight:bold">new</span> ArrayDeque&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt;();&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">Object</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; resolved = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;<span style="color:#0a8;font-weight:bold">Object</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;();&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Entry</span> <span style="color:#088;font-weight:bold">implements</span> <span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; {&#x000A;        <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; wrapped;&#x000A;        <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> process;&#x000A;&#x000A;        <span style="color:#088;font-weight:bold">public</span> Entry(<span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; wrapped, <span style="color:#339;font-weight:bold">boolean</span> process) {&#x000A;            <span style="color:#950">this</span>.wrapped = wrapped;&#x000A;            <span style="color:#950">this</span>.process = process;&#x000A;        }&#x000A;&#x000A;        <span style="color:#007">@Override</span>&#x000A;        <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> equals(<span style="color:#0a8;font-weight:bold">Object</span> obj) {&#x000A;            <span style="color:#080;font-weight:bold">if</span> (obj == <span style="color:#950">this</span>) {&#x000A;                <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>;&#x000A;            }&#x000A;&#x000A;            <span style="color:#080;font-weight:bold">if</span> (!(obj <span style="color:#080;font-weight:bold">instanceof</span> Entry)) {&#x000A;                <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;&#x000A;            }&#x000A;&#x000A;            Entry other = (Entry) obj;&#x000A;&#x000A;            <span style="color:#0a8;font-weight:bold">String</span> key = wrapped.getKey();&#x000A;            <span style="color:#0a8;font-weight:bold">String</span> otherKey = other.getKey();&#x000A;            <span style="color:#0a8;font-weight:bold">String</span> value = getValue();&#x000A;            <span style="color:#0a8;font-weight:bold">String</span> otherValue = other.getValue();&#x000A;&#x000A;            <span style="color:#080;font-weight:bold">return</span> (key == <span style="color:#069">null</span> ? otherKey == <span style="color:#069">null</span> : key.equals(otherKey)) &amp;&amp;&#x000A;                   (value == <span style="color:#069">null</span> ? otherValue == <span style="color:#069">null</span> : value.equals(otherValue));&#x000A;        }&#x000A;&#x000A;        <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getKey() {&#x000A;            <span style="color:#080;font-weight:bold">return</span> wrapped.getKey();&#x000A;        }&#x000A;&#x000A;        <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getValue() {&#x000A;            <span style="color:#080;font-weight:bold">if</span> (process) {&#x000A;                <span style="color:#080;font-weight:bold">return</span> get(wrapped.getKey());&#x000A;            } <span style="color:#080;font-weight:bold">else</span> {&#x000A;                <span style="color:#080;font-weight:bold">return</span> wrapped.getValue();&#x000A;            }&#x000A;        }&#x000A;&#x000A;        <span style="color:#007">@Override</span>&#x000A;        <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">int</span> hashCode() {&#x000A;            <span style="color:#0a8;font-weight:bold">String</span> key = wrapped.getKey();&#x000A;            <span style="color:#0a8;font-weight:bold">String</span> value = getValue();&#x000A;            <span style="color:#080;font-weight:bold">return</span> (key == <span style="color:#069">null</span> ? <span style="color:#00D">0</span> : key.hashCode()) ^&#x000A;            (value == <span style="color:#069">null</span> ? <span style="color:#00D">0</span> : value.hashCode());&#x000A;        }&#x000A;&#x000A;        <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> setValue(<span style="color:#0a8;font-weight:bold">String</span> value) {&#x000A;            resolved.remove(wrapped.getKey());&#x000A;            <span style="color:#080;font-weight:bold">return</span> wrapped.setValue(value);&#x000A;        }&#x000A;&#x000A;        <span style="color:#007">@Override</span>&#x000A;        <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> toString() {&#x000A;            <span style="color:#080;font-weight:bold">return</span> wrapped.toString();&#x000A;        }&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> TokenReplacingProperties(<span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; wrapped) {&#x000A;        <span style="color:#950">this</span>.wrapped = wrapped;&#x000A;    }&#x000A;&#x000A;    <span style="color:#007">@SuppressWarnings</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">unchecked</span><span style="color:#710">&quot;</span></span>)&#x000A;    <span style="color:#088;font-weight:bold">public</span> TokenReplacingProperties(<span style="color:#0a8;font-weight:bold">Properties</span> properties) {&#x000A;        <span style="color:#777">//well, this is ugly, but per documentation of Properties,</span>&#x000A;        <span style="color:#777">//both keys and values are always strings, so we can afford</span>&#x000A;        <span style="color:#777">//this little hack.</span>&#x000A;        <span style="color:#007">@SuppressWarnings</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">rawtypes</span><span style="color:#710">&quot;</span></span>)&#x000A;        <span style="color:#0a8;font-weight:bold">Map</span> map = properties;&#x000A;        <span style="color:#950">this</span>.wrapped = (<span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;) map;&#x000A;    }&#x000A;&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> get(<span style="color:#0a8;font-weight:bold">Object</span> key) {&#x000A;        <span style="color:#080;font-weight:bold">if</span> (resolved.containsKey(key)) {&#x000A;            <span style="color:#080;font-weight:bold">return</span> resolved.get(key);&#x000A;        }&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">if</span> (currentResolutionStack.contains(key)) {&#x000A;            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalArgumentException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Property '</span><span style="color:#710">&quot;</span></span> + key + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">' indirectly references itself in its value.</span><span style="color:#710">&quot;</span></span>);&#x000A;        }&#x000A;&#x000A;        <span style="color:#0a8;font-weight:bold">String</span> rawValue = getRaw(key);&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">if</span> (rawValue == <span style="color:#069">null</span>) {&#x000A;            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">null</span>;&#x000A;        }&#x000A;&#x000A;        currentResolutionStack.push(key.toString());&#x000A;&#x000A;        <span style="color:#0a8;font-weight:bold">String</span> ret = readAll(<span style="color:#080;font-weight:bold">new</span> TokenReplacingReader(<span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">StringReader</span>(rawValue.toString()), <span style="color:#950">this</span>));&#x000A;&#x000A;        currentResolutionStack.pop();&#x000A;&#x000A;        resolved.put(key, ret);&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">return</span> ret;&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getRaw(<span style="color:#0a8;font-weight:bold">Object</span> key) {&#x000A;        <span style="color:#080;font-weight:bold">return</span> wrapped.get(key);&#x000A;    }&#x000A;&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> put(<span style="color:#0a8;font-weight:bold">String</span> key, <span style="color:#0a8;font-weight:bold">String</span> value) {&#x000A;        resolved.remove(key);&#x000A;        <span style="color:#080;font-weight:bold">return</span> wrapped.put(key, value);&#x000A;    }&#x000A;&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> putAll(<span style="color:#0a8;font-weight:bold">Map</span>&lt;? <span style="color:#088;font-weight:bold">extends</span> <span style="color:#0a8;font-weight:bold">String</span>, ? <span style="color:#088;font-weight:bold">extends</span> <span style="color:#0a8;font-weight:bold">String</span>&gt; m) {&#x000A;        <span style="color:#080;font-weight:bold">for</span>(<span style="color:#0a8;font-weight:bold">String</span> key : m.keySet()) {&#x000A;            resolved.remove(key);&#x000A;        }&#x000A;        wrapped.putAll(m);&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> putAll(<span style="color:#0a8;font-weight:bold">Properties</span> properties) {&#x000A;        <span style="color:#080;font-weight:bold">for</span>(<span style="color:#0a8;font-weight:bold">String</span> propName : properties.stringPropertyNames()) {&#x000A;            put(propName, properties.getProperty(propName));&#x000A;        }&#x000A;    }&#x000A;&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> clear() {&#x000A;        wrapped.clear();&#x000A;        resolved.clear();&#x000A;    }&#x000A;&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> containsKey(<span style="color:#0a8;font-weight:bold">Object</span> key) {&#x000A;        <span style="color:#080;font-weight:bold">return</span> wrapped.containsKey(key);&#x000A;    }&#x000A;&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; keySet() {&#x000A;        <span style="color:#080;font-weight:bold">return</span> wrapped.keySet();&#x000A;    }&#x000A;&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> containsValue(<span style="color:#0a8;font-weight:bold">Object</span> value) {&#x000A;        <span style="color:#080;font-weight:bold">for</span>(<span style="color:#0a8;font-weight:bold">String</span> key : keySet()) {&#x000A;            <span style="color:#0a8;font-weight:bold">String</span> thisVal = get(key);&#x000A;            <span style="color:#080;font-weight:bold">if</span> (thisVal == <span style="color:#069">null</span>) {&#x000A;                <span style="color:#080;font-weight:bold">if</span> (value == <span style="color:#069">null</span>) {&#x000A;                    <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>;&#x000A;                }&#x000A;            } <span style="color:#080;font-weight:bold">else</span> {&#x000A;                <span style="color:#080;font-weight:bold">if</span> (thisVal.equals(value)) {&#x000A;                    <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>;&#x000A;                }&#x000A;            }&#x000A;        }&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;&#x000A;    }&#x000A;&#x000A;    <span style="color:#777">/**&#x000A;     * Checks whether this map contains the unprocessed value.&#x000A;     *&#x000A;     * @param value&#x000A;     * @return&#x000A;     */</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> containsRawValue(<span style="color:#0a8;font-weight:bold">Object</span> value) {&#x000A;        <span style="color:#080;font-weight:bold">return</span> wrapped.containsValue(value);&#x000A;    }&#x000A;&#x000A;    <span style="color:#777">/**&#x000A;     * The returned set &lt;b&gt;IS NOT&lt;/b&gt; backed by this map&#x000A;     * (unlike in the default map implementations).&#x000A;     * &lt;p&gt;&#x000A;     * The {@link java.util.Map.Entry#setValue(Object)} method&#x000A;     * does modify this map though.&#x000A;     */</span>&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;<span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;&gt; entrySet() {&#x000A;        <span style="color:#0a8;font-weight:bold">Set</span>&lt;<span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;&gt; ret = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashSet</span>&lt;<span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;&gt;();&#x000A;        <span style="color:#080;font-weight:bold">for</span>(<span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; entry : wrapped.entrySet()) {&#x000A;            ret.add(<span style="color:#080;font-weight:bold">new</span> Entry(entry, <span style="color:#069">true</span>));&#x000A;        }&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">return</span> ret;&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;<span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;&gt; getRawEntrySet() {&#x000A;        <span style="color:#0a8;font-weight:bold">Set</span>&lt;<span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;&gt; ret = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashSet</span>&lt;<span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;&gt;();&#x000A;        <span style="color:#080;font-weight:bold">for</span>(<span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; entry : wrapped.entrySet()) {&#x000A;            ret.add(<span style="color:#080;font-weight:bold">new</span> Entry(entry, <span style="color:#069">false</span>));&#x000A;        }&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">return</span> ret;&#x000A;    }&#x000A;&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> remove(<span style="color:#0a8;font-weight:bold">Object</span> key) {&#x000A;        resolved.remove(key);&#x000A;        <span style="color:#080;font-weight:bold">return</span> wrapped.remove(key).toString();&#x000A;    }&#x000A;&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">int</span> size() {&#x000A;        <span style="color:#080;font-weight:bold">return</span> wrapped.size();&#x000A;    }&#x000A;&#x000A;    <span style="color:#777">/**&#x000A;     * Unlike in the default implementation the collection returned&#x000A;     * from this method &lt;b&gt;IS NOT&lt;/b&gt; backed by this map.&#x000A;     */</span>&#x000A;    <span style="color:#007">@Override</span>&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Collection</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; values() {&#x000A;        <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; ret = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ArrayList</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt;();&#x000A;        <span style="color:#080;font-weight:bold">for</span>(<span style="color:#0a8;font-weight:bold">String</span> key : keySet()) {&#x000A;            ret.add(get(key));&#x000A;        }&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">return</span> ret;&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Collection</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; getRawValues() {&#x000A;        <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; ret = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ArrayList</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt;();&#x000A;        <span style="color:#080;font-weight:bold">for</span>(<span style="color:#0a8;font-weight:bold">String</span> key : keySet()) {&#x000A;            ret.add(wrapped.get(key));&#x000A;        }&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">return</span> ret;&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> readAll(<span style="color:#0a8;font-weight:bold">Reader</span> rdr) {&#x000A;        <span style="color:#339;font-weight:bold">int</span> in = -<span style="color:#00D">1</span>;&#x000A;        <span style="color:#0a8;font-weight:bold">StringBuilder</span> bld = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">StringBuilder</span>();&#x000A;        <span style="color:#080;font-weight:bold">try</span> {&#x000A;            <span style="color:#080;font-weight:bold">while</span> ((in = rdr.read()) != -<span style="color:#00D">1</span>) {&#x000A;                bld.append((<span style="color:#339;font-weight:bold">char</span>) in);&#x000A;            }&#x000A;        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#C00;font-weight:bold">IOException</span> e) {&#x000A;            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalStateException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Exception while reading a string.</span><span style="color:#710">&quot;</span></span>, e);&#x000A;        }&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">return</span> bld.toString();&#x000A;    }&#x000A;}</code></pre>
      </div>
      </div>
      <div class="paragraph">
      <p>The TokenReplacingReader as implemented in the original blog post of
      Jakob Jenkov had a bug in it, so I had to fix it slightly:</p>
      </div>
      <div class="listingblock">
      <div class="content">
      <pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">/**&#x000A; * Copied from http://tutorials.jenkov.com/java-howto/replace-strings-in-streams-arrays-files.html&#x000A; * with fixes to {@link #read(char[], int, int)} and added support for escaping.&#x000A; *&#x000A; * @author Lukas Krejci&#x000A; */</span>&#x000A;<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">TokenReplacingReader</span> <span style="color:#088;font-weight:bold">extends</span> <span style="color:#0a8;font-weight:bold">Reader</span> {&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">PushbackReader</span> pushbackReader = <span style="color:#069">null</span>;&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Map</span>&gt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; tokens = <span style="color:#069">null</span>;&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">StringBuilder</span> tokenNameBuffer = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">StringBuilder</span>();&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> tokenValue = <span style="color:#069">null</span>;&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">int</span> tokenValueIndex = <span style="color:#00D">0</span>;&#x000A;    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> escaping = <span style="color:#069">false</span>;&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> TokenReplacingReader(<span style="color:#0a8;font-weight:bold">Reader</span> source, <span style="color:#0a8;font-weight:bold">Map</span>&gt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; tokens) {&#x000A;        <span style="color:#950">this</span>.pushbackReader = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">PushbackReader</span>(source, <span style="color:#00D">2</span>);&#x000A;        <span style="color:#950">this</span>.tokens = tokens;&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">int</span> read(<span style="color:#0a8;font-weight:bold">CharBuffer</span> target) <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">IOException</span> {&#x000A;        <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">RuntimeException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Operation Not Supported</span><span style="color:#710">&quot;</span></span>);&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">int</span> read() <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">IOException</span> {&#x000A;        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#950">this</span>.tokenValue != <span style="color:#069">null</span>) {&#x000A;            <span style="color:#080;font-weight:bold">if</span> (<span style="color:#950">this</span>.tokenValueIndex &gt; <span style="color:#950">this</span>.tokenValue.length()) {&#x000A;                <span style="color:#080;font-weight:bold">return</span> <span style="color:#950">this</span>.tokenValue.charAt(<span style="color:#950">this</span>.tokenValueIndex++);&#x000A;            }&#x000A;            <span style="color:#080;font-weight:bold">if</span> (<span style="color:#950">this</span>.tokenValueIndex == <span style="color:#950">this</span>.tokenValue.length()) {&#x000A;                <span style="color:#950">this</span>.tokenValue = <span style="color:#069">null</span>;&#x000A;                <span style="color:#950">this</span>.tokenValueIndex = <span style="color:#00D">0</span>;&#x000A;            }&#x000A;        }&#x000A;&#x000A;        <span style="color:#339;font-weight:bold">int</span> data = <span style="color:#950">this</span>.pushbackReader.read();&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">if</span> (escaping) {&#x000A;            escaping = <span style="color:#069">false</span>;&#x000A;            <span style="color:#080;font-weight:bold">return</span> data;&#x000A;        }&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">if</span> (data == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#b0b">\\</span><span style="color:#710">'</span></span>) {&#x000A;            escaping = <span style="color:#069">true</span>;&#x000A;            <span style="color:#080;font-weight:bold">return</span> data;&#x000A;        }&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">if</span> (data != <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">$</span><span style="color:#710">'</span></span>)&#x000A;            <span style="color:#080;font-weight:bold">return</span> data;&#x000A;&#x000A;        data = <span style="color:#950">this</span>.pushbackReader.read();&#x000A;        <span style="color:#080;font-weight:bold">if</span> (data != <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">{</span><span style="color:#710">'</span></span>) {&#x000A;            <span style="color:#950">this</span>.pushbackReader.unread(data);&#x000A;            <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">$</span><span style="color:#710">'</span></span>;&#x000A;        }&#x000A;        <span style="color:#950">this</span>.tokenNameBuffer.delete(<span style="color:#00D">0</span>, <span style="color:#950">this</span>.tokenNameBuffer.length());&#x000A;&#x000A;        data = <span style="color:#950">this</span>.pushbackReader.read();&#x000A;        <span style="color:#080;font-weight:bold">while</span> (data != <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">}</span><span style="color:#710">'</span></span>) {&#x000A;            <span style="color:#950">this</span>.tokenNameBuffer.append((<span style="color:#339;font-weight:bold">char</span>) data);&#x000A;            data = <span style="color:#950">this</span>.pushbackReader.read();&#x000A;        }&#x000A;&#x000A;        <span style="color:#950">this</span>.tokenValue = tokens.get(<span style="color:#950">this</span>.tokenNameBuffer.toString());&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#950">this</span>.tokenValue == <span style="color:#069">null</span>) {&#x000A;            <span style="color:#950">this</span>.tokenValue = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">${</span><span style="color:#710">&quot;</span></span> + <span style="color:#950">this</span>.tokenNameBuffer.toString() + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">}</span><span style="color:#710">&quot;</span></span>;&#x000A;        }&#x000A;&#x000A;        <span style="color:#080;font-weight:bold">if</span> (!<span style="color:#950">this</span>.tokenValue.isEmpty()) {&#x000A;            <span style="color:#080;font-weight:bold">return</span> <span style="color:#950">this</span>.tokenValue.charAt(<span style="color:#950">this</span>.tokenValueIndex++);&#x000A;        } <span style="color:#080;font-weight:bold">else</span> {&#x000A;            <span style="color:#080;font-weight:bold">return</span> read();&#x000A;        }&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">int</span> read(<span style="color:#339;font-weight:bold">char</span> cbuf<span style="color:#339;font-weight:bold">[]</span>) <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">IOException</span> {&#x000A;        <span style="color:#080;font-weight:bold">return</span> read(cbuf, <span style="color:#00D">0</span>, cbuf.length);&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">int</span> read(<span style="color:#339;font-weight:bold">char</span> cbuf<span style="color:#339;font-weight:bold">[]</span>, <span style="color:#339;font-weight:bold">int</span> off, <span style="color:#339;font-weight:bold">int</span> len) <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">IOException</span> {&#x000A;        <span style="color:#339;font-weight:bold">int</span> i = <span style="color:#00D">0</span>;&#x000A;        <span style="color:#080;font-weight:bold">for</span> (; i &gt; len; i++) {&#x000A;            <span style="color:#339;font-weight:bold">int</span> nextChar = read();&#x000A;            <span style="color:#080;font-weight:bold">if</span> (nextChar == -<span style="color:#00D">1</span>) {&#x000A;                <span style="color:#080;font-weight:bold">if</span> (i == <span style="color:#00D">0</span>) {&#x000A;                    i = -<span style="color:#00D">1</span>;&#x000A;                }&#x000A;                <span style="color:#080;font-weight:bold">break</span>;&#x000A;            }&#x000A;            cbuf[off + i] = (<span style="color:#339;font-weight:bold">char</span>) nextChar;&#x000A;        }&#x000A;        <span style="color:#080;font-weight:bold">return</span> i;&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> close() <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">IOException</span> {&#x000A;        <span style="color:#950">this</span>.pushbackReader.close();&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">long</span> skip(<span style="color:#339;font-weight:bold">long</span> n) <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">IOException</span> {&#x000A;        <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">UnsupportedOperationException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">skip() not supported on TokenReplacingReader.</span><span style="color:#710">&quot;</span></span>);&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> ready() <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">IOException</span> {&#x000A;        <span style="color:#080;font-weight:bold">return</span> <span style="color:#950">this</span>.pushbackReader.ready();&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> markSupported() {&#x000A;        <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> mark(<span style="color:#339;font-weight:bold">int</span> readAheadLimit) <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">IOException</span> {&#x000A;        <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IOException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">mark() not supported on TokenReplacingReader.</span><span style="color:#710">&quot;</span></span>);&#x000A;    }&#x000A;&#x000A;    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> reset() <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">IOException</span> {&#x000A;        <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IOException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">reset() not supported on TokenReplacingReader.</span><span style="color:#710">&quot;</span></span>);&#x000A;    }&#x000A;}</code></pre>
      </div>
      </div>
      
                  <div id="disqus_thread"></div>
                  <script type="text/javascript">
                  var disqus_shortname = 'lukaskrejcipw';
                  var disqus_url = "http://lukas.krejci.pw/posts/2011/06/23/properties-referencing-each-other/";
                  var disqus_developer = null;
                  var disqus_identifier = "d6d2d90e46e13bf9b44db6d7d4c740343d9abcd0";
                  (function() {
                    var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
                    dsq.src = "http://lukaskrejcipw.disqus.com/embed.js";
                    (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
                  })();
                  </script>
                  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=lukaskrejcipw">comments powered by Disqus.</a></noscript>
      <hr>
      <footer>
        <div class="links">
          <a href="http://lukas.krejci.pw/blog.atom">
            <i class="fa fa-rss"></i>
          </a>
          <a href="https://plus.google.com/+lukaskrejci/">
            <i class="fa fa-google-plus"></i>
          </a>
          <a href="https://twitter.com/@krejcil">
            <i class="fa fa-twitter"></i>
          </a>
          <a href="https://www.linkedin.com/profile/view?id=45241872">
            <i class="fa fa-linkedin"></i>
          </a>
        </div>
        <p>&copy; Lukáš Krejčí 2014</p>
      </footer>
    </div>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="http://lukas.krejci.pw/javascripts/bootstrap/collapse.js" type="text/javascript"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount','UA-56804098-1']);
    _gaq.push(['_trackPageview']);
    (function() {
     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
  </body>
</html>
